# ูุธุงู ุชุนููู ุงูุจูุงูุงุช ูุงูุญุฐู ุงูุชููุงุฆู

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุฅุถุงูุฉ ูุธุงู ุดุงูู ูุฅุฏุงุฑุฉ ุตูุงุญูุงุช ุงููุชุงุฌุฑ ูุชุถูู:

1. โ **ุชุนููู ุงูุจูุงูุงุช ุชููุงุฆูุงู** ุนูุฏ ุงูุชูุงุก ุตูุงุญูุฉ ุงูุงุดุชุฑุงู
2. โ **ููุน ุฅุฏุฎุงู ุงูุจูุงูุงุช** ูููุชุงุฌุฑ ุงููุนููุฉ
3. โ **ุญุฐู ุชููุงุฆู** ุจุนุฏ 5 ุฃูุงู ูู ุงูุชูุงุก ุงูุตูุงุญูุฉ
4. โ **ุชูุจููุงุช ูุชุนุฏุฏุฉ** ูุจู ุงูุชุนููู ูุงูุญุฐู
5. โ **ุฑุจุท ูู ุงููุณุชุฎุฏููู** ุจุตูุงุญูุฉ ุงููุชุฌุฑ

---

## ๐ ุขููุฉ ุงูุนูู

### 1. ุนูุฏ ุงูุชูุงุก ุงูุตูุงุญูุฉ

ุนูุฏูุง ุชูุชูู ุตูุงุญูุฉ ุงุดุชุฑุงู ูุชุฌุฑ:

1. **ุชุนููู ุชููุงุฆู ููุจูุงูุงุช**:
   - ูุชู ุชุนุทูู ุฌููุน ูุณุชุฎุฏูู ุงููุชุฌุฑ
   - ูุชู ุชุนููู ุฅุฏุฎุงู ุงูุจูุงูุงุช (ููุน INSERT/UPDATE)
   - ูุชู ุนุฑุถ ุฑุณุงูุฉ ุชุญุฐูุฑูุฉ ูููุณุชุฎุฏู

2. **ุฅูุดุงุก ุฅุดุนุงุฑ**:
   - ูุชู ุฅูุดุงุก ุฅุดุนุงุฑ ูู ุฌุฏูู `subscription_notifications`
   - ููุน ุงูุฅุดุนุงุฑ: `suspended`

### 2. ุจุนุฏ 5 ุฃูุงู ูู ุงูุชูุงุก ุงูุตูุงุญูุฉ

ุฅุฐุง ูู ูุชู ุงูุชุฌุฏูุฏ ุฎูุงู 5 ุฃูุงู:

1. **ุชุญุฐูุฑ ููุงุฆู** (ููู 4):
   - ูุชู ุฅุฑุณุงู ุชุญุฐูุฑ ููุงุฆู
   - ูุชู ุชุญุฏูุฏ ุชุงุฑูุฎ ุงูุญุฐู (ุจุนุฏ 24 ุณุงุนุฉ)

2. **ุญุฐู ุชููุงุฆู** (ููู 5):
   - ูุชู ุญุฐู ุฌููุน ุจูุงูุงุช ุงููุชุฌุฑ ุชููุงุฆูุงู
   - ูุชู ุญุฐู ุงููุณุชุฎุฏููู ูุงูุจูุงูุงุช ุงููุฑุชุจุทุฉ (CASCADE)
   - ูุชู ุฅูุดุงุก ุฅุดุนุงุฑ ููุงุฆู

---

## ๐ ุงูุฌุฏุงูู ูุงููุธุงุฆู

### ุงูุฌุฏุงูู ุงูุฌุฏูุฏุฉ:

1. **subscription_notifications**
   - ุชุณุฌูู ุฌููุน ุงูุชูุจููุงุช ูุงูุฅุดุนุงุฑุงุช
   - ุฃููุงุน ุงูุฅุดุนุงุฑุงุช: `expiring_soon`, `expired`, `suspended`, `deletion_warning`, `deleted`

### ุงูุญููู ุงููุถุงูุฉ ูุฌุฏูู tenants:

- `data_suspended` - ุญุงูุฉ ุชุนููู ุงูุจูุงูุงุช
- `suspension_date` - ุชุงุฑูุฎ ุงูุชุนููู
- `deletion_scheduled_date` - ุชุงุฑูุฎ ุงูุญุฐู ุงููุญุฏุฏ
- `deletion_warning_sent` - ุชู ุฅุฑุณุงู ุชุญุฐูุฑ ุงูุญุฐู

### ุงููุธุงุฆู (Functions):

1. **check_and_suspend_expired_tenants()**
   - ุงูุชุญูู ูู ุงููุชุงุฌุฑ ุงูููุชููุฉ ุงูุตูุงุญูุฉ
   - ุฅุฑุฌุงุน ูุงุฆูุฉ ุจุงููุชุงุฌุฑ ุงูุชู ูุฌุจ ุชุนููููุง ุฃู ุญุฐููุง

2. **suspend_tenant_data(tenant_id)**
   - ุชุนููู ุจูุงูุงุช ุงููุชุฌุฑ
   - ุชุนุทูู ุฌููุน ุงููุณุชุฎุฏููู
   - ุฅูุดุงุก ุฅุดุนุงุฑ

3. **delete_expired_tenant_data(tenant_id)**
   - ุญุฐู ุจูุงูุงุช ุงููุชุฌุฑ ุจุนุฏ 5 ุฃูุงู
   - ุฅูุดุงุก ุชุญุฐูุฑ ูุจู ุงูุญุฐู
   - ุญุฐู ููุงุฆู ููุจูุงูุงุช

4. **check_user_access(user_id)**
   - ุงูุชุญูู ูู ุตูุงุญูุฉ ุงููุณุชุฎุฏู ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู
   - ููุน ุงูุฏุฎูู ูููุณุชุฎุฏููู ุงููุนูููู

5. **ensure_tenant_active(tenant_id)**
   - ุงูุชุญูู ูู ุตูุงุญูุฉ ุงููุชุฌุฑ ูุจู ุฃู ุนูููุฉ
   - ููุน ุฅุฏุฎุงู ุงูุจูุงูุงุช ูููุชุงุฌุฑ ุงููุนููุฉ

6. **process_expired_tenants()**
   - ูุนุงูุฌุฉ ุฌููุน ุงููุชุงุฌุฑ ุงูููุชููุฉ ุงูุตูุงุญูุฉ
   - ูููู ุงุณุชุฏุนุงุคูุง ุฏูุฑูุงู (Cron Job)

---

## ๐ก๏ธ Triggers ุงูุญูุงูุฉ

ุชู ุฅุถุงูุฉ Triggers ูููุน ุฅุฏุฎุงู ุงูุจูุงูุงุช ูููุชุงุฌุฑ ุงููุนููุฉ ุนูู:

- `invoices_in` - ููุงุชูุฑ ุงููุงุฑุฏ
- `invoices_out` - ููุงุชูุฑ ุงูุตุงุฏุฑ
- `inventory_items` - ุงููุฎุฒูู
- `partners` - ุงูุนููุงุก ูุงูููุฑุฏูู
- `employees` - ุงูููุธููู
- `contractor_projects` - ูุดุงุฑูุน ุงูููุงูููู
- `project_items` - ุจููุฏ ุงููููุงุช (BOQ)
- `fuel_products` - ููุชุฌุงุช ุงููุญุฑููุงุช

**ุฑุณุงูุฉ ุงูุฎุทุฃ**: "ุชู ุชุนููู ุจูุงูุงุช ูุฐุง ุงููุชุฌุฑ ุจุณุจุจ ุงูุชูุงุก ุตูุงุญูุฉ ุงูุงุดุชุฑุงู. ูุฑุฌู ุงูุชุฌุฏูุฏ ููุงุณุชูุฑุงุฑ."

---

## ๐ ุงูุชูุงูู ูุน Frontend

### 1. AuthContext.jsx

ุชู ุชุญุฏูุซ `AuthContext` ูู:
- ุงูุชุญูู ูู ุญุงูุฉ ุงูุชุนููู ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู
- ุนุฑุถ ุฑุณุงุฆู ุชุญุฐูุฑูุฉ ููุงุณุจุฉ
- ููุน ุงููุตูู ูููุณุชุฎุฏููู ุงููุนูููู

### 2. App.jsx

ุชู ุชุญุฏูุซ `App.jsx` ูู:
- ุฅุนุงุฏุฉ ุชูุฌูู ุงููุณุชุฎุฏููู ุงููุนูููู ุฅูู ุตูุญุฉ ุงูุงุดุชุฑุงู
- ููุน ุงููุตูู ูุฌููุน ุงูุตูุญุงุช (ูุงุนุฏุง `/subscription` ู `/settings`)

### 3. neonService.js

ุชู ุฅุถุงูุฉ:
- `checkUserAccess(userId)` - ููุชุญูู ูู ุตูุงุญูุฉ ุงููุณุชุฎุฏู
- `processExpiredTenants()` - ููุนุงูุฌุฉ ุงููุชุงุฌุฑ ุงูููุชููุฉ (ููุงุณุชุฏุนุงุก ูู Admin)

---

## โ๏ธ ุงูุฅุนุฏุงุฏ ูุงูุงุณุชุฎุฏุงู

### 1. ุชุทุจูู ููู SQL:

```sql
-- ูู ุจุชุดุบูู ุงูููู ุงูุชุงูู ูู Neon SQL Editor:
COMPREHENSIVE_STORE_IMPROVEMENTS.sql
```

### 2. ุฅุนุฏุงุฏ Cron Job (ุงุฎุชูุงุฑู):

ูููุนุงูุฌุฉ ุงูุชููุงุฆูุฉ ุงูุฏูุฑูุฉุ ูููู ุฅุนุฏุงุฏ Cron Job:

```sql
-- ุงุณุชุฏุนุงุก ูููู ููุนุงูุฌุฉ ุงููุชุงุฌุฑ ุงูููุชููุฉ
SELECT * FROM process_expired_tenants();
```

ุฃู ูู Admin Panel:
```javascript
await neonService.processExpiredTenants();
```

### 3. ุงูุชุญูู ุงููุฏูู:

```sql
-- ุนุฑุถ ุงููุชุงุฌุฑ ุงูููุชููุฉ ุงูุตูุงุญูุฉ
SELECT * FROM check_and_suspend_expired_tenants();

-- ุชุนููู ูุชุฌุฑ ูุญุฏุฏ
SELECT suspend_tenant_data('tenant-id-here');

-- ุญุฐู ูุชุฌุฑ ูุญุฏุฏ (ุจุนุฏ 5 ุฃูุงู)
SELECT delete_expired_tenant_data('tenant-id-here');
```

---

## ๐ ุณููุงุฑูููุงุช ุงูุงุณุชุฎุฏุงู

### ุงูุณููุงุฑูู 1: ุงูุชูุงุก ุตูุงุญูุฉ ุนุงุฏูุฉ

1. ููุชูู ุงุดุชุฑุงู ุงููุชุฌุฑ
2. ูุญุงูู ุงููุณุชุฎุฏู ุชุณุฌูู ุงูุฏุฎูู
3. ูุชู ุชุนููู ุงูุจูุงูุงุช ุชููุงุฆูุงู
4. ูุชู ุนุฑุถ ุฑุณุงูุฉ: "ุชู ุชุนููู ุจูุงูุงุช ูุชุฌุฑู..."
5. ูุชู ููุน ุฅุฏุฎุงู ุฃู ุจูุงูุงุช ุฌุฏูุฏุฉ

### ุงูุณููุงุฑูู 2: ุชุฌุฏูุฏ ุงูุงุดุชุฑุงู

1. ูููู ุงููุฏูุฑ ุจุชุฌุฏูุฏ ุงูุงุดุชุฑุงู
2. ูุชู ุฅูุบุงุก ุงูุชุนููู ุชููุงุฆูุงู
3. ูุชู ุชูุนูู ุฌููุน ุงููุณุชุฎุฏููู
4. ูุนูุฏ ุงููุธุงู ููุนูู ุจุดูู ุทุจูุนู

### ุงูุณููุงุฑูู 3: ุนุฏู ุงูุชุฌุฏูุฏ (5 ุฃูุงู)

1. ุงูููู 1-4: ุงูุจูุงูุงุช ูุนููุฉุ ุงูุชุญุฐูุฑุงุช ูุณุชูุฑุฉ
2. ุงูููู 4: ุชุญุฐูุฑ ููุงุฆู ูุจู 24 ุณุงุนุฉ
3. ุงูููู 5: ุญุฐู ุชููุงุฆู ูุฌููุน ุงูุจูุงูุงุช
4. ุฅุดุนุงุฑ ููุงุฆู: "ุชู ุญุฐู ุจูุงูุงุช ูุชุฌุฑู..."

---

## ๐ ุงูุชูุจููุงุช ูุงูุฅุดุนุงุฑุงุช

### ุฃููุงุน ุงูุชูุจููุงุช:

1. **expiring_soon** - ูุจู 7 ุฃูุงู ูู ุงูุงูุชูุงุก
2. **expired** - ุนูุฏ ุงูุชูุงุก ุงูุตูุงุญูุฉ
3. **suspended** - ุนูุฏ ุชุนููู ุงูุจูุงูุงุช
4. **deletion_warning** - ูุจู 24 ุณุงุนุฉ ูู ุงูุญุฐู
5. **deleted** - ุจุนุฏ ุงูุญุฐู ุงูุชููุงุฆู

### ุนุฑุถ ุงูุชูุจููุงุช:

ูููู ุนุฑุถ ุงูุชูุจููุงุช ูู:
```sql
SELECT * FROM subscription_notifications 
WHERE tenant_id = 'tenant-id' 
ORDER BY sent_at DESC;
```

---

## โ๏ธ ููุงุญุธุงุช ูููุฉ

1. **ุงูุญุฐู ููุงุฆู**: ุจุนุฏ ุงูุญุฐู ุงูุชููุงุฆูุ ูุง ูููู ุงุณุชุฑุฌุงุน ุงูุจูุงูุงุช
2. **Super Admin**: ูุง ูุชุฃุซุฑ ุจูุธุงู ุงูุชุนููู ูุงูุญุฐู
3. **CASCADE**: ุญุฐู ุงููุชุฌุฑ ูุญุฐู ุฌููุน ุงูุจูุงูุงุช ุงููุฑุชุจุทุฉ ุชููุงุฆูุงู
4. **ุงูุชุฌุฏูุฏ**: ุนูุฏ ุงูุชุฌุฏูุฏุ ูุชู ุฅูุบุงุก ุงูุชุนููู ุชููุงุฆูุงู

---

## ๐ฏ ุงูุฎูุงุตุฉ

ุงููุธุงู ุงูุขู:
- โ ูุนูู ุงูุจูุงูุงุช ุชููุงุฆูุงู ุนูุฏ ุงูุชูุงุก ุงูุตูุงุญูุฉ
- โ ูููุน ุฅุฏุฎุงู ุงูุจูุงูุงุช ูููุชุงุฌุฑ ุงููุนููุฉ
- โ ูุญุฐู ุงูุจูุงูุงุช ุชููุงุฆูุงู ุจุนุฏ 5 ุฃูุงู
- โ ูุฑุณู ุชูุจููุงุช ูุชุนุฏุฏุฉ
- โ ูุฑุจุท ุฌููุน ุงููุณุชุฎุฏููู ุจุตูุงุญูุฉ ุงููุชุฌุฑ

ุฌููุน ุงูููุฒุงุช ุชุนูู ุชููุงุฆูุงู ููุชูุงููุฉ! ๐

